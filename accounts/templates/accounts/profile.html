{% extends 'base.html' %}

{% block content %}
  <br>
  <h2>{{ person.username }}'s Profile</h2>
  <hr>
  {% with followings=person.followings.all followers=person.followers.all %}
    <div>
      <div id="follow-count-{{ person.pk }}">
        팔로잉 : {{ followings|length }} / 팔로워 : {{ followers|length }}
      </div>
      {% if request.user != person %}
        <div>
          <form class="follow-form", data-user-id="{{ person.pk }}">
            {% csrf_token %}
            <br>
            {% if request.user in followers %}
              <button id="followBtn" class='btn btn-outline-secondary'>언팔로우</button>
            {% else %}
              <button id="followBtn" class='btn btn-outline-secondary'>팔로우</button>
            {% endif %}
          </form>
        </div>
      {% endif %}
    </div>
  {% endwith %}

  <br>
  <hr>
  <h3><i class="fas fa-archive"></i> My movie story.</h3>
  <table class="table table-striped table-hover">
    <thead>
      <tr style="text-align:center">
        <th>분류</th>
        <th>TITLE</th>
        <th>작성일</th>
      </tr>
    </thead>
    <tbody>
      {% for review in person.review_set.all %}
      <tr>
        <td>{{ review.classification }}</td>
        <td><a href="{% url 'community:detail' review.pk %}" class='link-success' style='text-decoration:none'>{{ review.title }}</td>
        <td>{{ review.created_at|date:'y년 m월 d일' }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
  <br><hr>


{% endblock content %}

{% block script %}
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script>
    const form = document.querySelector('.follow-form')
    const URL = 'http://127.0.0.1:8000/accounts/'

    form.addEventListener('submit', event => {
      event.preventDefault()
      const userID = event.target.getAttribute('data-user-id')
      axios.defaults.xsrfCookieName = 'csrftoken'
      axios.defaults.xsrfHeaderName = 'X-CSRFTOKEN'
      axios.post(URL+`${userID}/follow/`)
      .then(response => {
        if (response.data.isFollowed) {
          followBtn.setAttribute('class', 'btn btn-outline-warning')
          followBtn.innerText = '언팔로우'
        } else {
          followBtn.setAttribute('class', 'btn btn-outline-secondary')
          followBtn.innerText = '팔로우'
        }
        const followCount = document.querySelector(`#follow-count-${userID}`)
        const followings_count = response.data.followings_count
        const followers_count = response.data.followers_count
        followCount.innerText = `팔로잉 수 : ${followings_count} / 팔로워 수 : ${followers_count}`
      })
    })
  </script>
{% endblock script %}